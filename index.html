<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ä¸–èˆˆåˆç´„è‡ªå‹•ç”Ÿæˆå™¨</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f6f9; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; font-size: 24px; }
        
        .section { margin-bottom: 20px; padding: 20px; border: 1px solid #e1e4e8; border-radius: 8px; background-color: #fff; }
        .section-title { font-weight: bold; color: #2980b9; margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; display: flex; align-items: center; justify-content: space-between; }
        
        /* è¡¨å–®æ§åˆ¶é … */
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.95em; }
        input[type="text"], input[type="number"] { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; background-color: #fcfcfc; transition: border 0.3s; }
        input[type="text"]:focus, input[type="number"]:focus { border-color: #2980b9; background-color: #fff; outline: none; }
        
        /* ç¯„æœ¬é¸æ“‡å€ */
        .template-options { display: flex; gap: 15px; margin-bottom: 10px; flex-wrap: wrap; }
        .radio-label { cursor: pointer; display: flex; align-items: center; gap: 5px; background: #f8f9fa; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; transition: all 0.2s; }
        .radio-label:hover { background: #e9ecef; }
        /* é¸ä¸­æ™‚çš„æ¨£å¼ */
        input[type="radio"]:checked + span { color: #2980b9; font-weight: bold; }
        .radio-label:has(input:checked) { background: #e8f4fd; border-color: #2980b9; }
        
        /* æª”æ¡ˆä¸Šå‚³ */
        input[type="file"] { display: block; width: 100%; padding: 10px; background: #fafafa; border: 1px dashed #ccc; margin-top: 5px; }

        /* é è¦½ç·¨è¼¯å€ */
        .preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        
        button { background-color: #27ae60; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 20px; transition: background 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button:hover { background-color: #219150; transform: translateY(-1px); }
        
        #status { margin-top: 20px; padding: 15px; text-align: center; font-weight: bold; border-radius: 6px; }
        .warn-text { color: #e67e22; font-size: 0.85em; margin-top: 5px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
</head>
<body>

<div class="container">
    <h1>âœˆï¸ ä¸–èˆˆåˆç´„è‡ªå‹•ç”Ÿæˆå™¨</h1>
    
    <div class="section">
        <div class="section-title">1. é¸æ“‡åˆç´„ç¯„æœ¬</div>
        <div class="template-options">
            <label class="radio-label">
                <input type="radio" name="templateType" value="group" onchange="handleTemplateChange()" checked> 
                <span>åœ‹å¤–åœ˜é«”</span>
            </label>
            <label class="radio-label">
                <input type="radio" name="templateType" value="individual" onchange="handleTemplateChange()"> 
                <span>åœ‹å¤–å€‹åˆ¥</span>
            </label>
            <label class="radio-label">
                <input type="radio" name="templateType" value="individualcn" onchange="handleTemplateChange()"> 
                <span>å¤§é™¸å€‹åˆ¥</span>
            </label>
            <label class="radio-label">
                <input type="radio" name="templateType" value="mgroup" onchange="handleTemplateChange()"> 
                <span>åœ‹å¤–åœ˜é«”MAC</span>
            </label>
            <label class="radio-label">
                <input type="radio" name="templateType" value="mindividual" onchange="handleTemplateChange()"> 
                <span>åœ‹å¤–å€‹åˆ¥MAC</span>
            </label>
            <label class="radio-label">
                <input type="radio" name="templateType" value="mindividualcn" onchange="handleTemplateChange()"> 
                <span>å¤§é™¸å€‹åˆ¥MAC</span>
            </label>
            <label class="radio-label">
                <input type="radio" name="templateType" value="custom" onchange="handleTemplateChange()"> 
                <span>ä¸Šå‚³å…¶ä»–ç¯„æœ¬</span>
            </label>
        </div>
        
        <div id="customUploadArea" style="display:none;">
            <input type="file" id="customTemplateFile" accept=".docx" />
        </div>
        <div class="warn-text">
            ğŸ’¡ æç¤ºï¼šé¸æ“‡ã€Œåœ‹å¤–å€‹åˆ¥ã€æˆ–ã€Œå¤§é™¸å€‹åˆ¥ã€æ™‚ï¼Œä¸‹æ–¹çš„æ—¥æœŸç©ºæ ¼æœƒè‡ªå‹•èª¿æ•´ç‚º 3 æ ¼ã€‚
        </div>
    </div>

    <div class="section">
        <div class="section-title">2. ä¸Šå‚³ç§‘å¨æª”æ¡ˆä¸¦ç·¨è¼¯è³‡æ–™</div>
        <p style="font-size:0.9em; margin-bottom:10px;">è«‹ä¸Šå‚³ç§‘å¨åŒ¯å‡ºçš„.docæª”æ¡ˆï¼Œç³»çµ±å°‡è‡ªå‹•è§£æä¸¦é¡¯ç¤ºæ–¼ä¸‹æ–¹ã€‚</p>
        <input type="file" id="dataFile" accept=".doc,.html,.htm" onchange="previewData()" />
        
        <div style="margin-top:15px; border-top:1px dashed #ddd; padding-top:10px; background-color: #fcfcfc; padding: 10px; border-radius: 6px;">
            <p style="font-size:0.9em; color:#666; margin:0 0 5px 0;">ğŸ‘‡ è‹¥æª”æ¡ˆç„¡æ³•è¾¨è­˜ï¼Œè«‹ç›´æ¥è²¼ä¸Šæ•´ä¸²æ–‡å­— (å¦‚: CJJ05260206A éŸ“åœ‹é¦–çˆ¾...)</p>
            <div style="display:flex; gap:10px;">
                <input type="text" id="rawStringInput" placeholder="åœ¨æ­¤è²¼ä¸Šåœ˜è™Ÿ+åœ˜åæ–‡å­—ä¸²" style="flex:1;">
                <button onclick="parseManualString()" style="width:auto; margin-top:0; padding:8px 15px; font-size:14px; background:#17a2b8;">è§£ææ–‡å­—</button>
            </div>
        </div>
        <div id="previewSection" style="display:none; margin-top:20px; border-top: 1px dashed #ddd; padding-top: 20px;">
            <h3 style="margin-top:0; color:#2c3e50;">ğŸ“ è³‡æ–™é è¦½èˆ‡ç·¨è¼¯</h3>
            <div class="preview-grid">
                <div class="full-width">
                    <label>åœ˜å</label>
                    <input type="text" id="prev_groupName">
                </div>
                <div>
                    <label>åœ˜è™Ÿ</label>
                    <input type="text" id="prev_groupNo" onchange="updateCountryFromCode()">
                </div>
                <div>
                    <label>å‡ºç™¼æ—¥æœŸ (æ°‘åœ‹å¹´)</label>
                    <input type="text" id="prev_date">
                </div>
                <div>
                    <label>æ—…éŠåœ‹å®¶ (è‡ªå‹•åˆ¤åˆ¥)</label>
                    <input type="text" id="prev_country">
                </div>
                <div>
                    <label>æˆåœ˜äººæ•¸</label>
                    <input type="number" id="prev_minPax" value="16">
                </div>
                <div class="full-width">
                    <label>å”è¾¦æ—…è¡Œç¤¾</label>
                    <input type="text" id="prev_agency" value="æ—…è¡Œç¤¾">
                </div>
            </div>
            <div style="margin-top:15px; background:#f8f9fa; padding:10px; border-radius:5px;">
                <label>ç³»çµ±è­˜åˆ¥åˆ°çš„æ—…å®¢ (åƒ…ä¾›ç¢ºèªï¼Œè«‹å‹¿åœ¨æ­¤ä¿®æ”¹)</label>
                <div id="paxListPreview" style="font-size:0.9em; color:#666; max-height:100px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <button onclick="generateContracts()">ğŸš€ ç¢ºèªè³‡æ–™ç„¡èª¤ï¼Œç”Ÿæˆ Word åˆç´„</button>
    <div id="status"></div>
</div>

<script>
    // === å…¨åŸŸè®Šæ•¸ ===
    let globalExtractedPax = []; 
    
    // === æ©Ÿå ´ä»£ç¢¼å°ç…§è¡¨ ===
    const AIRPORT_MAP = {
        "TYO": "æ—¥æœ¬", "NRT": "æ—¥æœ¬", "HND": "æ—¥æœ¬", "KIX": "æ—¥æœ¬", "FUK": "æ—¥æœ¬",
        "CTS": "æ—¥æœ¬", "OKA": "æ—¥æœ¬", "SDJ": "æ—¥æœ¬", "KMQ": "æ—¥æœ¬", "HKD": "æ—¥æœ¬",
        "SEL": "éŸ“åœ‹", "ICN": "éŸ“åœ‹", "GMP": "éŸ“åœ‹", "PUS": "éŸ“åœ‹", "CJU": "éŸ“åœ‹", "MWX": "éŸ“åœ‹", "TAE": "éŸ“åœ‹",
        "BKK": "æ³°åœ‹", "DMK": "æ³°åœ‹", "CNX": "æ³°åœ‹", "HKT": "æ³°åœ‹",
        "DAD": "è¶Šå—", "HAN": "è¶Šå—", "SGN": "è¶Šå—", "CXR": "è¶Šå—", "PQC": "è¶Šå—",
        "SIN": "æ–°åŠ å¡", "KUL": "é¦¬ä¾†è¥¿äº", "BKI": "é¦¬ä¾†è¥¿äº",
        "MNL": "è²å¾‹è³“", "CEB": "è²å¾‹è³“", "KLO": "è²å¾‹è³“",
        "HKG": "é¦™æ¸¯", "MFM": "æ¾³é–€", "PEK": "ä¸­åœ‹å¤§é™¸", "PVG": "ä¸­åœ‹å¤§é™¸", "SHA": "ä¸­åœ‹å¤§é™¸",
        "TPE": "å°ç£", "KHH": "å°ç£" 
    };

    // è™•ç†ç¯„æœ¬åˆ‡æ›äº‹ä»¶ (åˆä½µé¡¯ç¤ºä¸Šå‚³æ¡†èˆ‡æ›´æ–°æ—¥æœŸæ ¼å¼)
    function handleTemplateChange() {
        const radio = document.querySelector('input[name="templateType"]:checked');
        const val = radio.value;
        
        // 1. æ§åˆ¶è‡ªè¨‚ä¸Šå‚³æ¡†é¡¯ç¤º
        const uploadArea = document.getElementById('customUploadArea');
        uploadArea.style.display = (val === 'custom') ? 'block' : 'none';

        // 2. ç«‹å³è§¸ç™¼æ—¥æœŸæ ¼å¼æ›´æ–°
        updateDateSpacing();
    }

    // === æ ¸å¿ƒåŠŸèƒ½ï¼šå‹•æ…‹èª¿æ•´æ—¥æœŸç©ºæ ¼ (æ‰€è¦‹å³æ‰€å¾—) ===
    function updateDateSpacing() {
        const dateInput = document.getElementById('prev_date');
        let val = dateInput.value.trim();
        if (!val) return;

        // ç”¨æ­£å‰‡æŠ“å‡ºå¹´ã€æœˆã€æ—¥ (ä¸ç®¡ä¸­é–“æœ‰å¹¾å€‹ç©ºæ ¼)
        const match = val.match(/^(\d+)\s+(\d+)\s+(\d+)$/);
        
        if (match) {
            const [_, y, m, d] = match;
            const templateType = document.querySelector('input[name="templateType"]:checked').value;
            
            // æ±ºå®šç©ºæ ¼æ•¸é‡
            let spaces = "  "; // é è¨­ 2 æ ¼ (åœ˜é«”)
            if (templateType === 'individual' || templateType === 'individualcn' || templateType === 'mindividual' || templateType === 'mindividualcn') {
                spaces = "   "; // å€‹åˆ¥ç´„ 3 æ ¼
            }
            
            // é‡æ–°çµ„è£ä¸¦å¯«å›è¼¸å…¥æ¡†
            dateInput.value = `${y}${spaces}${m}${spaces}${d}`;
        }
    }

    function updateCountryFromCode() {
        const groupCode = document.getElementById('prev_groupNo').value;
        if(groupCode.length >= 3) {
            const code = groupCode.substring(0, 3).toUpperCase();
            const country = AIRPORT_MAP[code];
            if(country) document.getElementById('prev_country').value = country;
        }
    }

    // === æ–°å¢ï¼šæ‰‹å‹•è§£æåœ˜è™Ÿåœ˜å ===
    function parseManualString() {
        const raw = document.getElementById('rawStringInput').value.trim();
        if(!raw) {
            alert("è«‹å…ˆè¼¸å…¥æ–‡å­—ä¸²ï¼");
            return;
        }

        // æ­£å‰‡è¡¨é”å¼é‚è¼¯èªªæ˜ï¼š
        // [A-Z]{3}  : å‰ä¸‰ç¢¼æ©Ÿå ´ä»£ç¢¼ (å¦‚ CJJ)
        // \d{2}     : å¤©æ•¸ (å¦‚ 05)
        // (\d{6})   : æ—¥æœŸ (å¦‚ 260206)ï¼Œé€™æ˜¯æˆ‘å€‘è¦æŠ“çš„ group[2]
        // [A-Z0-9]* : å°¾ç¢¼ (å¦‚ A)
        const codeRegex = /([A-Z]{3}\d{2}(\d{6})[A-Z0-9]*)/;
        const match = raw.match(codeRegex);

        if (match) {
            const fullGroupCode = match[1]; // æŠ“åˆ°çš„å®Œæ•´åœ˜è™Ÿ
            const datePart = match[2];      // æŠ“åˆ°çš„æ—¥æœŸéƒ¨åˆ† YYMMDD

            // 1. å¡«å…¥åœ˜è™Ÿ
            document.getElementById('prev_groupNo').value = fullGroupCode;

            // 2. è§£æä¸¦å¡«å…¥åœ˜å (æŠŠåœ˜è™Ÿå¾åŸå§‹å­—ä¸²ä¸­æ‰£æ‰ï¼Œå‰©ä¸‹çš„å°±æ˜¯åœ˜å)
            let name = raw.replace(fullGroupCode, '').trim();
            name = name.replace(/^[-\s]+/, ''); // å»é™¤é–‹é ­å¤šé¤˜çš„æ©«ç·šæˆ–ç©ºç™½
            document.getElementById('prev_groupName').value = name;

            // 3. è§£æä¸¦å¡«å…¥æ—¥æœŸ
            // è½‰æ› 260206 -> 2026/02/06
            const yy = parseInt(datePart.substring(0, 2));
            const mm = datePart.substring(2, 4);
            const dd = datePart.substring(4, 6);
            const fullYear = 2000 + yy; 
            
            const isoDateStr = `${fullYear}/${mm}/${dd}`;
            document.getElementById('prev_date').value = toRocDate(isoDateStr);

            // 4. è§¸ç™¼é€£å‹•åŠŸèƒ½
            updateCountryFromCode();
            updateDateSpacing();

            // 5. é¡¯ç¤ºç·¨è¼¯å€
            document.getElementById('previewSection').style.display = 'block';

        } else {
            alert("ç„¡æ³•è¾¨è­˜åœ˜è™Ÿæ ¼å¼ï¼\nè«‹ç¢ºèªå­—ä¸²åŒ…å«é¡ä¼¼ 'CJJ05260206A' çš„çµæ§‹ã€‚");
        }
    }

    async function previewData() {
        const dataInput = document.getElementById('dataFile').files[0];
        if (!dataInput) return;

        try {
            const dataText = await readFileAsText(dataInput);
            const parser = new DOMParser();
            const doc = parser.parseFromString(dataText, "text/html");
            const extracted = parseSystemData(doc);

            globalExtractedPax = extracted.passengers;

            document.getElementById('prev_groupName').value = extracted.groupInfo.åœ˜å;
            document.getElementById('prev_groupNo').value = extracted.groupInfo.åœ˜è™Ÿ;
            
            // åˆå§‹å¡«å…¥æ—¥æœŸ
            document.getElementById('prev_date').value = toRocDate(extracted.groupInfo.å‡ºç™¼æ—¥æœŸ);
            
            updateCountryFromCode();
            
            // *** é‡è¦ï¼šè³‡æ–™è¼‰å…¥å¾Œï¼Œç«‹åˆ»ä¾ç…§ç•¶å‰é¸æ“‡çš„ç¯„æœ¬èª¿æ•´ç©ºæ ¼ ***
            updateDateSpacing();

            const paxPreviewDiv = document.getElementById('paxListPreview');
            paxPreviewDiv.innerText = `å…± ${globalExtractedPax.length} ä½ï¼š` + globalExtractedPax.map(p=>p.å§“å).join("ã€");

            document.getElementById('previewSection').style.display = 'block';

        } catch (e) {
            console.error(e);
            alert("æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚");
        }
    }

    async function loadDefaultTemplate(filename) {
        try {
            const response = await fetch(filename);
            if (!response.ok) throw new Error(`æ‰¾ä¸åˆ°æª”æ¡ˆ ${filename}`);
            return await response.arrayBuffer();
        } catch (e) {
            alert(`è®€å–é è¨­ç¯„æœ¬å¤±æ•—ï¼š\nè«‹ç¢ºèª ${filename} æ˜¯å¦èˆ‡æ­¤ç¶²é åœ¨åŒä¸€è³‡æ–™å¤¾ä¸­ã€‚\n\n(è‹¥ä½¿ç”¨ Chromeï¼Œè«‹å˜—è©¦æ‰‹å‹•ä¸Šå‚³ç¯„æœ¬)`);
            throw e;
        }
    }

    async function generateContracts() {
        const statusDiv = document.getElementById('status');
        
        let templateArrayBuffer = null;
        const templateType = document.querySelector('input[name="templateType"]:checked').value;
        let templateFilename = 'group.docx';

        try {
            if (templateType === 'custom') {
                const fileInput = document.getElementById('customTemplateFile').files[0];
                if (!fileInput) { alert("è«‹ä¸Šå‚³è‡ªè¨‚ç¯„æœ¬ï¼"); return; }
                templateArrayBuffer = await readFileAsArrayBuffer(fileInput);
            } else {
                if (templateType === 'group') templateFilename = 'group.docx';
                else if (templateType === 'individual') templateFilename = 'individual.docx';
                else if (templateType === 'individualcn') templateFilename = 'individualcn.docx';
                else if (templateType === 'mindividual') templateFilename = 'mindividual.docx';
                else if (templateType === 'mindividualcn') templateFilename = 'mindividualcn.docx';
                templateArrayBuffer = await loadDefaultTemplate(templateFilename);
            }
        } catch (e) { return; }

        if (globalExtractedPax.length === 0) {
            alert("å°šæœªè®€å–åˆ°æ—…å®¢è³‡æ–™ï¼");
            return;
        }

        statusDiv.innerText = "â³ æ­£åœ¨ç”Ÿæˆ...";
        statusDiv.style.backgroundColor = "#fff3cd";
        
        try {
            const zip = new PizZip(templateArrayBuffer);
            const docx = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });

            const finalGroupNo = document.getElementById('prev_groupNo').value;
            const finalGroupName = document.getElementById('prev_groupName').value;
            
            // ç›´æ¥æ‹¿é è¦½æ¡†çš„å€¼ (å› ç‚º updateDateSpacing å·²ç¶“ä¿è­‰å®ƒæ˜¯å°çš„)
            const finalDate = document.getElementById('prev_date').value;
            
            const finalCountry = document.getElementById('prev_country').value;
            const finalAgency = document.getElementById('prev_agency').value;
            const finalMinPax = document.getElementById('prev_minPax').value;

            const allPax = globalExtractedPax;
            const totalCount = allPax.length;
            let mainNameStr = "", sideNameStr = "", fullListStr = "";

            if (totalCount > 0) {
                mainNameStr = allPax.slice(0, 2).map(p => p.å§“å).join("ã€");
            }

            if (totalCount > 14) {
                sideNameStr = "åå–®å¦‚é™„ä»¶";
                fullListStr = `${allPax[0].å§“å} ç­‰å…± ${totalCount} ä½ åå–®å¦‚é™„ä»¶`;
            } else {
                const restPax = allPax.slice(2);
                let lines = [];
                for (let i = 0; i < restPax.length; i += 3) {
                    lines.push(restPax.slice(i, i + 3).map(p => p.å§“å).join("ã€"));
                }
                sideNameStr = lines.join("\n");
                fullListStr = allPax.map(p => p.å§“å).join("ã€");
            }

            const contractData = {
                "åœ˜è™Ÿ": finalGroupNo,
                "åœ˜å": finalGroupName,
                "å‡ºç™¼æ—¥æœŸ": finalDate,
                "æ—…éŠåœ‹å®¶": finalCountry,
                "å”è¾¦æ—…è¡Œç¤¾": finalAgency,
                "æˆåœ˜äººæ•¸": finalMinPax,
                "ä¸»è¦å§“å": mainNameStr,
                "é…è§’åå–®": sideNameStr,
                "äººæ•¸": totalCount,
                "å®Œæ•´å§“åä¸²": fullListStr
            };

            docx.render(contractData);
            
            const blob = docx.getZip().generate({
                type: "blob",
                mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            });

            // æª”åå„ªåŒ–ï¼šå»é™¤ "æ—…è¡Œç¤¾"
            const agencyShort = finalAgency.replace(/æ—…è¡Œç¤¾/g, "");
            const outputFileName = `${finalGroupNo}${agencyShort}åˆç´„.docx`;

            saveAs(blob, outputFileName);
            
            statusDiv.innerHTML = `ğŸ‰ æˆåŠŸï¼æª”æ¡ˆå·²ä¸‹è¼‰ï¼š<br>${outputFileName}`;
            statusDiv.style.backgroundColor = "#d4edda";

        } catch (error) {
            console.error(error);
            alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
            statusDiv.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤";
            statusDiv.style.backgroundColor = "#f8d7da";
        }
    }

    function toRocDate(dateStr) {
        if (!dateStr) return "";
        const dateObj = new Date(dateStr);
        if (isNaN(dateObj.getTime())) return dateStr;
        const year = dateObj.getFullYear() - 1911;
        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        const day = dateObj.getDate().toString().padStart(2, '0');
        // é è¨­çµ¦å€‹åˆå§‹å€¼ï¼ŒçœŸæ­£æ ¼å¼ç”± updateDateSpacing æ§åˆ¶
        return `${year}  ${month}  ${day}`;
    }

    function parseSystemData(doc) {
        let groupNo = "";
        const groupNoMatch = doc.body.innerHTML.match(/åœ˜è™Ÿï¼š(.*?)&nbsp;/);
        if (groupNoMatch) groupNo = groupNoMatch[1].trim();

        let groupName = "";
        const groupNameMatch = doc.body.innerHTML.match(/åœ˜åï¼š(.*?)<\/td>/);
        if (!groupNameMatch) {
             const txt = doc.body.innerText;
             const m = txt.match(/åœ˜åï¼š(.*?)\n/);
             if(m) groupName = m[1].trim();
        } else {
             groupName = groupNameMatch[1].replace(/<.*?>/g, "").trim();
        }

        let date = "";
        const dateMatch = doc.body.textContent.match(/æœŸé–“ï¼š(\d{4}\/\d{2}\/\d{2})/);
        if (dateMatch) date = dateMatch[1];

        const passengers = [];
        const tables = doc.querySelectorAll('table[border="1"]');
        tables.forEach(table => {
            const rows = table.rows;
            if (rows.length > 0) {
                const cells = rows[0].cells;
                if (cells.length >= 5) {
                    const no = cells[0].innerText.trim();
                    if (!isNaN(no) && no !== "NO") {
                        let rawName = cells[1].innerText.trim();
                        let cleanName = rawName.split(/[a-zA-Z]/)[0].trim();
                        cleanName = cleanName.replace(/\//g, "");
                        passengers.push({ "å§“å": cleanName });
                    }
                }
            }
        });

        return {
            groupInfo: { "åœ˜è™Ÿ": groupNo, "åœ˜å": groupName, "å‡ºç™¼æ—¥æœŸ": date },
            passengers: passengers
        };
    }

    function readFileAsText(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsText(file, "UTF-8");
        });
    }

    function readFileAsArrayBuffer(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsArrayBuffer(file);
        });
    }
</script>

</body>
</html>