<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ä¸–èˆˆåˆç´„è‡ªå‹•ç”Ÿæˆå™¨</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f6f9; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; font-size: 24px; }
        
        .section { margin-bottom: 20px; padding: 20px; border: 1px solid #e1e4e8; border-radius: 8px; background-color: #fff; }
        .section-title { font-weight: bold; color: #2980b9; margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; display: flex; align-items: center; justify-content: space-between; }
        
        /* è¡¨å–®æ§åˆ¶é … */
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.95em; }
        input[type="text"], input[type="number"] { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; background-color: #fcfcfc; transition: border 0.3s; }
        input[type="text"]:focus, input[type="number"]:focus { border-color: #2980b9; background-color: #fff; outline: none; }
        
        /* ç¯„æœ¬é¸æ“‡å€ */
        .template-options { display: flex; gap: 15px; margin-bottom: 10px; flex-wrap: wrap; }
        .radio-label { cursor: pointer; display: flex; align-items: center; gap: 5px; background: #f8f9fa; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; }
        .radio-label:hover { background: #e9ecef; }
        input[type="radio"]:checked + span { color: #2980b9; font-weight: bold; }
        
        /* æª”æ¡ˆä¸Šå‚³ */
        input[type="file"] { display: block; width: 100%; padding: 10px; background: #fafafa; border: 1px dashed #ccc; margin-top: 5px; }

        /* é è¦½ç·¨è¼¯å€ */
        .preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        
        button { background-color: #27ae60; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 20px; transition: background 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button:hover { background-color: #219150; transform: translateY(-1px); }
        
        #status { margin-top: 20px; padding: 15px; text-align: center; font-weight: bold; border-radius: 6px; }
        .tag-box { background: #e8f4fd; padding: 10px; border-radius: 4px; font-family: monospace; color: #c7254e; font-size: 0.9em; word-break: break-all; margin-top: 5px; }
        
        .warn-text { color: #e67e22; font-size: 0.85em; margin-top: 5px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
</head>
<body>

<div class="container">
    <h1>âœˆï¸ ä¸–èˆˆåˆç´„è‡ªå‹•ç”Ÿæˆå™¨</h1>
    
    <div class="section">
        <div class="section-title">1. é¸æ“‡åˆç´„ç¯„æœ¬</div>
        <div class="template-options">
            <label class="radio-label">
                <input type="radio" name="templateType" value="group" onclick="toggleTemplateUpload(false)" checked> 
                <span>åœ‹å¤–åœ˜é«”</span>
            </label>
            <label class="radio-label">
                <input type="radio" name="templateType" value="individual" onclick="toggleTemplateUpload(false)"> 
                <span>åœ‹å¤–å€‹åˆ¥</span>
            </label>
            <label class="radio-label">
                <input type="radio" name="templateType" value="individualcn" onclick="toggleTemplateUpload(false)"> 
                <span>å¤§é™¸å€‹åˆ¥</span>
            </label>
            <label class="radio-label">
                <input type="radio" name="templateType" value="custom" onclick="toggleTemplateUpload(true)"> 
                <span>ä¸Šå‚³å…¶ä»–ç¯„æœ¬</span>
            </label>
        </div>
        
        <div id="customUploadArea" style="display:none;">
            <input type="file" id="customTemplateFile" accept=".docx" />
        </div>
    </div>

    <div class="section">
        <div class="section-title">2. ä¸Šå‚³ç§‘å¨æª”æ¡ˆä¸¦ç·¨è¼¯è³‡æ–™</div>
        <p style="font-size:0.9em; margin-bottom:10px;">è«‹ä¸Šå‚³ç§‘å¨åŒ¯å‡ºçš„.docæª”æ¡ˆ(åˆ—å°>ä¿éšªåå–®>é»word)ï¼Œç³»çµ±å°‡è‡ªå‹•è§£æä¸¦é¡¯ç¤ºæ–¼ä¸‹æ–¹ä¾›æ‚¨ä¿®æ”¹ã€‚</p>
        <input type="file" id="dataFile" accept=".doc,.html,.htm" onchange="previewData()" />
        
        <div id="previewSection" style="display:none; margin-top:20px; border-top: 1px dashed #ddd; padding-top: 20px;">
            <h3 style="margin-top:0; color:#2c3e50;">ğŸ“ è³‡æ–™é è¦½èˆ‡ç·¨è¼¯</h3>
            <div class="preview-grid">
                <div class="full-width">
                    <label>åœ˜å</label>
                    <input type="text" id="prev_groupName">
                </div>
                <div>
                    <label>åœ˜è™Ÿ</label>
                    <input type="text" id="prev_groupNo" onchange="updateCountryFromCode()">
                </div>
                <div>
                    <label>å‡ºç™¼æ—¥æœŸ (æ°‘åœ‹å¹´)</label>
                    <input type="text" id="prev_date">
                </div>
                <div>
                    <label>æ—…éŠåœ‹å®¶ (è‡ªå‹•åˆ¤åˆ¥)</label>
                    <input type="text" id="prev_country">
                </div>
                <div>
                    <label>æˆåœ˜äººæ•¸ (æœ€ä½å‡ºåœ˜äººæ•¸)</label>
                    <input type="number" id="prev_minPax" value="16">
                </div>
                <div class="full-width">
                    <label>å”è¾¦æ—…è¡Œç¤¾</label>
                    <input type="text" id="prev_agency" value="æ—…è¡Œç¤¾">
                </div>
            </div>
            <div style="margin-top:15px; background:#f8f9fa; padding:10px; border-radius:5px;">
                <label>ç³»çµ±è­˜åˆ¥åˆ°çš„æ—…å®¢ (åƒ…ä¾›ç¢ºèªï¼Œè«‹å‹¿åœ¨æ­¤ä¿®æ”¹)</label>
                <div id="paxListPreview" style="font-size:0.9em; color:#666; max-height:100px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <button onclick="generateContracts()">ğŸš€ ç¢ºèªè³‡æ–™ç„¡èª¤ï¼Œç”Ÿæˆ Word åˆç´„</button>
    <div id="status"></div>
</div>

<script>
    // === å…¨åŸŸè®Šæ•¸ ===
    let globalExtractedPax = []; 
    
    // === æ©Ÿå ´ä»£ç¢¼å°ç…§è¡¨ ===
    const AIRPORT_MAP = {
        "TYO": "æ—¥æœ¬", "NRT": "æ—¥æœ¬", "HND": "æ—¥æœ¬", "KIX": "æ—¥æœ¬", "FUK": "æ—¥æœ¬",
        "CTS": "æ—¥æœ¬", "OKA": "æ—¥æœ¬", "SDJ": "æ—¥æœ¬", "KMQ": "æ—¥æœ¬", "HKD": "æ—¥æœ¬",
        "SEL": "éŸ“åœ‹", "ICN": "éŸ“åœ‹", "GMP": "éŸ“åœ‹", "PUS": "éŸ“åœ‹", "CJU": "éŸ“åœ‹", "MWX": "éŸ“åœ‹", "TAE": "éŸ“åœ‹",
        "BKK": "æ³°åœ‹", "DMK": "æ³°åœ‹", "CNX": "æ³°åœ‹", "HKT": "æ³°åœ‹",
        "DAD": "è¶Šå—", "HAN": "è¶Šå—", "SGN": "è¶Šå—", "CXR": "è¶Šå—", "PQC": "è¶Šå—",
        "SIN": "æ–°åŠ å¡", "KUL": "é¦¬ä¾†è¥¿äº", "BKI": "é¦¬ä¾†è¥¿äº",
        "MNL": "è²å¾‹è³“", "CEB": "è²å¾‹è³“", "KLO": "è²å¾‹è³“",
        "HKG": "é¦™æ¸¯", "MFM": "æ¾³é–€", "PEK": "ä¸­åœ‹å¤§é™¸", "PVG": "ä¸­åœ‹å¤§é™¸", "SHA": "ä¸­åœ‹å¤§é™¸",
        "TPE": "å°ç£", "KHH": "å°ç£" 
    };

    // åˆ‡æ›ç¯„æœ¬ä¸Šå‚³æ¡†é¡¯ç¤º
    function toggleTemplateUpload(show) {
        document.getElementById('customUploadArea').style.display = show ? 'block' : 'none';
    }

    // ç•¶åœ˜è™Ÿæ”¹è®Šæ™‚ï¼Œé‡æ–°åˆ¤åˆ¥åœ‹å®¶
    function updateCountryFromCode() {
        const groupCode = document.getElementById('prev_groupNo').value;
        if(groupCode.length >= 3) {
            const code = groupCode.substring(0, 3).toUpperCase();
            const country = AIRPORT_MAP[code];
            if(country) document.getElementById('prev_country').value = country;
        }
    }

    // é è¦½åŠŸèƒ½ï¼šè§£æç³»çµ±æª”æ¡ˆä¸¦å¡«å…¥è¼¸å…¥æ¡†
    async function previewData() {
        const dataInput = document.getElementById('dataFile').files[0];
        if (!dataInput) return;

        try {
            const dataText = await readFileAsText(dataInput);
            const parser = new DOMParser();
            const doc = parser.parseFromString(dataText, "text/html");
            const extracted = parseSystemData(doc);

            // å„²å­˜å…¨åŸŸè®Šæ•¸
            globalExtractedPax = extracted.passengers;

            // 1. å¡«å…¥è¼¸å…¥æ¡†
            document.getElementById('prev_groupName').value = extracted.groupInfo.åœ˜å;
            document.getElementById('prev_groupNo').value = extracted.groupInfo.åœ˜è™Ÿ;
            document.getElementById('prev_date').value = toRocDate(extracted.groupInfo.å‡ºç™¼æ—¥æœŸ);
            
            // 2. è‡ªå‹•åˆ¤åˆ¥åœ‹å®¶
            updateCountryFromCode();

            // 3. é¡¯ç¤ºæ—…å®¢é è¦½
            const paxPreviewDiv = document.getElementById('paxListPreview');
            paxPreviewDiv.innerText = `å…± ${globalExtractedPax.length} ä½ï¼š` + globalExtractedPax.map(p=>p.å§“å).join("ã€");

            // é¡¯ç¤ºå€å¡Š
            document.getElementById('previewSection').style.display = 'block';

        } catch (e) {
            console.error(e);
            alert("æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚");
        }
    }

    // ä¸‹è¼‰ç¯„æœ¬æª”æ¡ˆ
    async function loadDefaultTemplate(filename) {
        try {
            const response = await fetch(filename);
            if (!response.ok) throw new Error(`æ‰¾ä¸åˆ°æª”æ¡ˆ ${filename}`);
            return await response.arrayBuffer();
        } catch (e) {
            alert(`è®€å–é è¨­ç¯„æœ¬å¤±æ•—ï¼š\nè«‹ç¢ºèª ${filename} æ˜¯å¦èˆ‡æ­¤ç¶²é åœ¨åŒä¸€è³‡æ–™å¤¾ä¸­ã€‚\n\n(è‹¥ä½¿ç”¨ Chrome ç›´æ¥é–‹å•Ÿ HTMLï¼Œå¯èƒ½æœƒå› å®‰å…¨æ€§è¢«é˜»æ“‹ï¼Œè«‹å˜—è©¦æ‰‹å‹•ä¸Šå‚³ç¯„æœ¬)`);
            throw e;
        }
    }

    async function generateContracts() {
        const statusDiv = document.getElementById('status');
        
        // 1. æ±ºå®šä½¿ç”¨å“ªå€‹ç¯„æœ¬
        let templateArrayBuffer = null;
        const templateType = document.querySelector('input[name="templateType"]:checked').value;
        let templateFilename = 'group.docx';

        try {
            if (templateType === 'custom') {
                const fileInput = document.getElementById('customTemplateFile').files[0];
                if (!fileInput) { alert("è«‹ä¸Šå‚³è‡ªè¨‚ç¯„æœ¬ï¼"); return; }
                templateArrayBuffer = await readFileAsArrayBuffer(fileInput);
            } else {
                // æ ¹æ“šé¡å‹é¸æ“‡æª”æ¡ˆ
                if (templateType === 'group') templateFilename = 'group.docx';
                else if (templateType === 'individual') templateFilename = 'individual.docx';
                else if (templateType === 'individualcn') templateFilename = 'individualcn.docx';
                
                templateArrayBuffer = await loadDefaultTemplate(templateFilename);
            }
        } catch (e) {
            return; 
        }

        if (globalExtractedPax.length === 0) {
            alert("å°šæœªè®€å–åˆ°æ—…å®¢è³‡æ–™ï¼Œè«‹å…ˆä¸Šå‚³ç³»çµ±æª”æ¡ˆï¼");
            return;
        }

        statusDiv.innerText = "â³ æ­£åœ¨ç”Ÿæˆ...";
        statusDiv.style.backgroundColor = "#fff3cd";
        
        try {
            const zip = new PizZip(templateArrayBuffer);
            const docx = new window.docxtemplater(zip, {
                paragraphLoop: true,
                linebreaks: true,
            });

            // --- å¾ã€Œç·¨è¼¯å€ã€å–å¾—æœ€çµ‚è³‡æ–™ ---
            const finalGroupNo = document.getElementById('prev_groupNo').value;
            const finalGroupName = document.getElementById('prev_groupName').value;
            let finalDate = document.getElementById('prev_date').value;
            const finalCountry = document.getElementById('prev_country').value;
            const finalAgency = document.getElementById('prev_agency').value;
            const finalMinPax = document.getElementById('prev_minPax').value;

            // === é‚è¼¯ä¿®æ­£ 1ï¼šä¾ç…§ç¯„æœ¬é¡å‹èª¿æ•´æ—¥æœŸç©ºæ ¼ ===
            // é è¨­æ˜¯ 2 æ ¼ï¼Œå¦‚æœæ˜¯å€‹åˆ¥ç´„ï¼Œæ”¹æˆ 3 æ ¼
            if (templateType === 'individual' || templateType === 'individualcn') {
                // å°‡æ‰€æœ‰é€£çºŒçš„2å€‹ç©ºç™½æ›æˆ3å€‹ç©ºç™½ (ç¢ºä¿æ ¼å¼ä¸€è‡´)
                finalDate = finalDate.replace(/  /g, "   ");
            }

            // --- æ—…å®¢åå–®é‚è¼¯ ---
            const allPax = globalExtractedPax;
            const totalCount = allPax.length;
            let mainNameStr = "";
            let sideNameStr = "";
            let fullListStr = "";

            if (totalCount > 0) {
                const firstTwo = allPax.slice(0, 2);
                mainNameStr = firstTwo.map(p => p.å§“å).join("ã€");
            }

            if (totalCount > 14) {
                sideNameStr = "åå–®å¦‚é™„ä»¶";
                const firstPaxName = allPax[0].å§“å;
                fullListStr = `${firstPaxName} ç­‰å…± ${totalCount} ä½ åå–®å¦‚é™„ä»¶`;
            } else {
                const restPax = allPax.slice(2);
                let lines = [];
                for (let i = 0; i < restPax.length; i += 3) {
                    const chunk = restPax.slice(i, i + 3).map(p => p.å§“å).join("ã€");
                    lines.push(chunk);
                }
                sideNameStr = lines.join("\n");
                fullListStr = allPax.map(p => p.å§“å).join("ã€");
            }

            // çµ„åˆè³‡æ–™
            const contractData = {
                "åœ˜è™Ÿ": finalGroupNo,
                "åœ˜å": finalGroupName,
                "å‡ºç™¼æ—¥æœŸ": finalDate,
                "æ—…éŠåœ‹å®¶": finalCountry,
                "å”è¾¦æ—…è¡Œç¤¾": finalAgency,
                "æˆåœ˜äººæ•¸": finalMinPax,
                "ä¸»è¦å§“å": mainNameStr,
                "é…è§’åå–®": sideNameStr,
                "äººæ•¸": totalCount,
                "å®Œæ•´å§“åä¸²": fullListStr
            };

            docx.render(contractData);
            
            const blob = docx.getZip().generate({
                type: "blob",
                mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            });

            // === é‚è¼¯ä¿®æ­£ 2ï¼šæª”åå„ªåŒ– ===
            // ç§»é™¤ "æ—…è¡Œç¤¾" ä¸‰å€‹å­—
            const agencyShort = finalAgency.replace(/æ—…è¡Œç¤¾/g, "");
            // çµ„åˆæª”å: åœ˜è™Ÿ + ç°¡çŸ­æ—…è¡Œç¤¾å + åˆç´„.docx
            const outputFileName = `${finalGroupNo}${agencyShort}åˆç´„.docx`;

            saveAs(blob, outputFileName);
            
            statusDiv.innerHTML = `ğŸ‰ æˆåŠŸï¼æª”æ¡ˆå·²ä¸‹è¼‰ï¼š<br>${outputFileName}`;
            statusDiv.style.backgroundColor = "#d4edda";

        } catch (error) {
            console.error(error);
            alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
            statusDiv.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤";
            statusDiv.style.backgroundColor = "#f8d7da";
        }
    }

    // --- è¼”åŠ©ï¼šæ—¥æœŸè½‰æ°‘åœ‹å¹´ (é è¨­å›å‚³ 2 æ ¼ç©ºç™½) ---
    function toRocDate(dateStr) {
        if (!dateStr) return "";
        const dateObj = new Date(dateStr);
        if (isNaN(dateObj.getTime())) return dateStr;
        const year = dateObj.getFullYear() - 1911;
        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        const day = dateObj.getDate().toString().padStart(2, '0');
        // é è¨­ä¸­é–“ç©ºå…©æ ¼
        return `${year}  ${month}  ${day}`;
    }

    // --- è§£æé‚è¼¯ ---
    function parseSystemData(doc) {
        let groupNo = "";
        const groupNoMatch = doc.body.innerHTML.match(/åœ˜è™Ÿï¼š(.*?)&nbsp;/);
        if (groupNoMatch) groupNo = groupNoMatch[1].trim();

        let groupName = "";
        const groupNameMatch = doc.body.innerHTML.match(/åœ˜åï¼š(.*?)<\/td>/);
        if (!groupNameMatch) {
             const txt = doc.body.innerText;
             const m = txt.match(/åœ˜åï¼š(.*?)\n/);
             if(m) groupName = m[1].trim();
        } else {
             groupName = groupNameMatch[1].replace(/<.*?>/g, "").trim();
        }

        let date = "";
        const dateMatch = doc.body.textContent.match(/æœŸé–“ï¼š(\d{4}\/\d{2}\/\d{2})/);
        if (dateMatch) date = dateMatch[1];

        const passengers = [];
        const tables = doc.querySelectorAll('table[border="1"]');
        tables.forEach(table => {
            const rows = table.rows;
            if (rows.length > 0) {
                const cells = rows[0].cells;
                if (cells.length >= 5) {
                    const no = cells[0].innerText.trim();
                    if (!isNaN(no) && no !== "NO") {
                        let rawName = cells[1].innerText.trim();
                        let cleanName = rawName.split(/[a-zA-Z]/)[0].trim();
                        cleanName = cleanName.replace(/\//g, "");
                        passengers.push({ "å§“å": cleanName });
                    }
                }
            }
        });

        return {
            groupInfo: { "åœ˜è™Ÿ": groupNo, "åœ˜å": groupName, "å‡ºç™¼æ—¥æœŸ": date },
            passengers: passengers
        };
    }

    function readFileAsText(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsText(file, "UTF-8");
        });
    }

    function readFileAsArrayBuffer(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsArrayBuffer(file);
        });
    }
</script>

</body>
</html>